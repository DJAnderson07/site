---
title: Mapping Statewide School Ratings with US Census Tracts
author: Daniel Anderson
date: '2017-11-13'
slug: mapping-statewide-school-ratings-with-us-census-tracts
categories: []
tags:
  - data_vis
  - mapping
---



<p>In this post, I’d like to share some work related to geo-spatial mapping, statewide school ratings, and US Census Bureau data using census tracts. Specifically, I wanted to investigate whether there was a relation between the median housing price in an area, and the statewide achievement ratings for schools in the corresponding area. There is a <a href="https://steinhardt.nyu.edu/scmsAdmin/media/users/lec321/Sirin_Articles/Sirin_2005.pdf">strong relation</a> between socio-economic status and student achievement, but less is known about how statewide ratings for schools relate to the demographics of the corresponding area. Fair warning - this is a rather long post, so you’ll have to have a bit of endurance to get through it all (I considered splitting it into two posts but it felt less cohesive). We’ll be using R to produce the following map.</p>
<iframe seamless src="../2017-11-13-mapping-statewide-school-ratings-with-us-census-tracts_files/map_schools.html" width="100%" height="500">
</iframe>
<p>This post uses the <a href="https://www.tidyverse.org">tidyverse</a>, <a href="http://thomasleeper.com">Thomas Leeper</a>’s <a href="https://github.com/leeper/rio">rio</a> package for data import and <a href="https://github.com/sfirke">Sam Firke</a>’s <a href="https://github.com/sfirke/janitor">janitor</a> package for quick cleaning up of column names. The <a href="https://rstudio.github.io/leaflet/">leaflet</a> packages, is used for mapping, as well the terrific <a href="https://github.com/walkerke/tidycensus">tidycensus</a> package by <a href="https://walkerke.github.io">Kyle Walker</a>, and the<br />
<a href="https://github.com/dkahle/ggmap">ggmap</a> package is used for pulling lattitude and longitude data from physical addresses. Finally, this post builds off a <a href="https://juliasilge.com/blog/using-tidycensus/">wonderful post</a> by <a href="https://juliasilge.com">Julia Silge</a>.</p>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>For this project, I wanted to use only publicly available data. I meandered around the Oregon Department of Education (ODE) website for a while and eventually came to the file I wanted: <a href="http://www.oregon.gov/ode/schools-and-districts/reportcards/reportcards/Pages/Accountability-Measures.aspx">Report Card Ratings for each school</a>. So let’s import the data directly from the ODE website, clean it up a bit, and take a look.</p>
<pre class="r"><code># load packages for data import/prep
library(tidyverse)
library(rio)
library(janitor)

ratings &lt;- import(&quot;http://www.oregon.gov/ode/schools-and-districts/reportcards/reportcards/Documents/rcdetails_1617.xlsx&quot;,
                  setclass = &quot;tbl_df&quot;) %&gt;% 
            clean_names()

# Clean up the file to what we need
achievement &lt;- ratings %&gt;% 
  filter(district_name == &quot;Portland SD 1J&quot;) %&gt;% 
  spread(indicator, rating) %&gt;% 
  clean_names() %&gt;% 
  select(school_name, achievement) %&gt;% 
  mutate(achievement = parse_number(achievement)) %&gt;% 
  filter(!is.na(achievement))
    
achievement</code></pre>
<pre><code>## # A tibble: 84 x 2
##                      school_name achievement
##                            &lt;chr&gt;       &lt;dbl&gt;
##  1   Abernethy Elementary School           5
##  2   Ainsworth Elementary School           5
##  3     Alameda Elementary School           5
##  4      Arleta Elementary School           3
##  5       Astor Elementary School           3
##  6    Atkinson Elementary School           4
##  7  Rosa Parks Elementary School           2
##  8       Beach Elementary School           3
##  9        Beaumont Middle School           4
## 10 Boise-Eliot Elementary School           2
## # ... with 74 more rows</code></pre>
<p>In the above code, we import the ratings, filter for only schools in Portland School District, spread the data out so we have different columns for each type of rating (achievement, growth, and student subgroup growth), and then select only the two variables we really need - the school name and the achievement rating.</p>
<p>This is a good start, but we don’t yet have the geographical coordinates of the schools. To do that, we’ll get another dataset from ODE that has the physical address of each school. We’ll then transform those addresses to lattitude and longitude using a bit of help from the <em>ggmap</em> package First, the addresses:</p>
<pre class="r"><code>addresses &lt;- import(&quot;http://www.ode.state.or.us/pubs/labels/SchoolMail.xls&quot;,
                    setclass = &quot;tbl_df&quot;) %&gt;% 
  clean_names() %&gt;% 
  filter(city == &quot;PORTLAND&quot;) %&gt;% 
  mutate(name = str_to_title(name)) %&gt;% 
  unite(address, c(address, city, state, zip), sep = &quot; &quot;) %&gt;% 
  select(name, address)
              
addresses</code></pre>
<pre><code>## # A tibble: 146 x 2
##                           name                                     address
##  *                       &lt;chr&gt;                                       &lt;chr&gt;
##  1 Abernethy Elementary School   2421 SE ORANGE AVE PORTLAND OR 97214-5398
##  2 Ainsworth Elementary School    2425 SW VISTA AVE PORTLAND OR 97201-2399
##  3   Alameda Elementary School   2732 NE FREMONT ST PORTLAND OR 97212-2542
##  4     Alder Elementary School    17200 SE ALDER ST PORTLAND OR 97233-4260
##  5     Alice Ott Middle School   12500 SE RAMONA ST PORTLAND OR 97236-4699
##  6        Alliance High School   4039 NE ALBERTA CT PORTLAND OR 97211-8199
##  7    Arleta Elementary School     5109 SE 66TH AVE PORTLAND OR 97206-4599
##  8              Arthur Academy 13717 SE DIVISION ST PORTLAND OR 97236-2841
##  9     Astor Elementary School       5601 N YALE ST PORTLAND OR 97203-5299
## 10  Atkinson Elementary School  5800 SE DIVISION ST PORTLAND OR 97206-1499
## # ... with 136 more rows</code></pre>
<p>After import, we limit to only schools in Portland because we’re going to be joining this dataset with our <em>ratings</em> dataset based on the school name, and we want to ensure we don’t join the data for schools with the same name but but different districts. Unfortunately, the <em>addresses</em> file doesn’t tell us the district, or we could include that as one of the keyed variables in our join.</p>
<p>We’ll now join the <em>addresses</em> dataset with our <em>ratings</em> dataset.</p>
<pre class="r"><code>d &lt;- inner_join(achievement, addresses, by = c(&quot;school_name&quot; = &quot;name&quot;))</code></pre>
<p>Now, we can find the longitude and lattitude of each school using the physical address with the help of the <em>ggmap</em> package and, specifically, the <code>geocode</code> function. This takes a bit of time.</p>
<pre class="r"><code>library(ggmap)
lat_long &lt;- geocode(d$address)
d &lt;- bind_cols(d, lat_long)
d[ ,c(1, 4:5)]</code></pre>
<pre><code>## # A tibble: 81 x 3
##                      school_name       lon      lat
##                            &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1   Abernethy Elementary School -122.6515 45.50576
##  2   Ainsworth Elementary School -122.7001 45.50995
##  3     Alameda Elementary School -122.6373 45.54771
##  4      Arleta Elementary School -122.5968 45.48616
##  5       Astor Elementary School -122.7303 45.57785
##  6    Atkinson Elementary School -122.6049 45.50503
##  7  Rosa Parks Elementary School -122.7129 45.58781
##  8       Beach Elementary School -122.6856 45.55763
##  9        Beaumont Middle School -122.6209 45.54885
## 10 Boise-Eliot Elementary School -122.6727 45.54786
## # ... with 71 more rows</code></pre>
<p>Note - an earlier draft of this post had specified <code>source = &quot;dsk&quot;</code> when running the <code>geocode</code> function. I was getting some missing values (~19%) when using google (the default) and I received no missing data with <code>source = &quot;dsk&quot;</code>. However, it seems the Data Science Toolkit website is fairly frequently overwhelmed. Last time I tried this it took forever and failed, so I suppose the best option may depend on the availability of the servers at time you run the function.</p>
</div>
<div id="mapping-the-data" class="section level2">
<h2>Mapping the data</h2>
<p>To map the data, we’ll use the <em>leaflet</em> and <em>sf</em> packages. We’ll first write a quick function that tells leaflet what color we want the schools in our map to appear depending on their statewide achievement rating. We’ll make a simple diverging palette, where low values are red, middle values are white, and high values are green. These colors must correspond with the possible values for <code>markerColor</code> from <code>leaflet::awesomeIcons</code>.</p>
<pre class="r"><code>library(leaflet)

get_col &lt;- function(df, indicator) {
  sapply(df[[as.character(indicator)]], function(rating) {
    if(rating == 5) {
      &quot;green&quot;
    } else if(rating == 4) {
      &quot;lightgreen&quot;
    } else if(rating == 3) {
      &quot;white&quot;
    } else if(rating == 2) {
      &quot;lightred&quot;
    } else {
      &quot;red&quot;
    } })
}</code></pre>
<p>Next we’ll map the Portland area using a combination of <em>leaflet</em> and the <em>tidycensus</em> packages to not only produce the map, but color census tracts according to the median housing income for the tract. Note that you have to have a US Census API key for these function to work (see <a href="https://walkerke.github.io/tidycensus/articles/basic-usage.html">here</a>). Below, I use the <code>get_acs</code> function from <em>tidycensus</em> package to pull census tract data for Multnomah County. The variable argument tells the function which variable to get data from (see the <code>load_variables</code> function for other variables).</p>
<pre class="r"><code>library(tidycensus)

pdx_acs &lt;- get_acs(geography = &quot;tract&quot;, 
                     variables = &quot;B25077_001&quot;, 
                     state = &quot;OR&quot;,
                     county = &quot;Multnomah County&quot;,
                     geometry = TRUE)</code></pre>
<p>The <code>pdx_acs</code> object now has data on the median housing cost for all census tracts in Multnomah County, as well as the geometry of each census tract. We can use this information to produce the map. First, however, we need to create a color palette for the tracts. We’ll use the viridis palette, which is not only beautiful, but also good for people with color blindness, as well as for printing in black and white. We’ll use the <code>colorNumeric</code> function from <em>leaflet</em>, and ask it to fill each tract according to the estimate of the median housing cost, which we just extracted with the <em>tidycensus</em> package.</p>
<pre class="r"><code>pal &lt;- colorNumeric(palette = &quot;viridis&quot;, 
                    domain = pdx_acs$estimate)</code></pre>
<p>Next we’ll get the actual icons we want to use, coloring them according to the achievement ratings. The last line in this code gets a hexadecimal approximation for these colors, which we’ll use in a legend later.</p>
<pre class="r"><code>pins &lt;- awesomeIcons(
  icon = &#39;ios-close&#39;,
  iconColor = &#39;black&#39;,
  library = &#39;ion&#39;,
  markerColor = get_col(d, &quot;achievement&quot;)
)

cols &lt;- gplots::col2hex(c(&quot;red&quot;, &quot;pink&quot;, &quot;white&quot;, &quot;lightgreen&quot;, &quot;darkgreen&quot;))</code></pre>
<p>Finally, we’ll produce the map, using the code below. Although it appears somewhat complicated, it’s actually not too bad, it’s just rather long(ish). Essentially we first separate <code>NAME</code> into three distinct variables for the census tract, county, and state, then we (a) create a blank map, (b) set the style in which we want the map to render, (c) add tract information, (d) add school information, and (e) add legends.</p>
<pre class="r"><code>pdx_acs %&gt;%
  separate(NAME, c(&quot;tract&quot;, &quot;county&quot;, &quot;state&quot;), sep = &quot;,&quot;) %&gt;% 
  leaflet() %&gt;%
  addProviderTiles(provider = &quot;Stamen.TerrainBackground&quot;) %&gt;%
  addPolygons(popup = ~ tract,
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal(estimate)) %&gt;%
  addAwesomeMarkers(data = d, 
                    ~lon, 
                    ~lat, 
                    icon = pins, 
                    popup= ~school_name) %&gt;% 
  addLegend(&quot;bottomright&quot;, 
            pal = pal, 
            values = ~ estimate,
            title = &quot;Median Home Value&quot;,
            labFormat = labelFormat(prefix = &quot;$&quot;),
            opacity = 1) %&gt;% 
  addLegend(&quot;bottomright&quot;, 
            colors = rev(cols),
            labels = 5:1,
            title = &quot;Achievement Ratings&quot;,
            opacity = 1)</code></pre>
<iframe seamless src="../2017-11-13-mapping-statewide-school-ratings-with-us-census-tracts_files/map_schools.html" width="100%" height="500">
</iframe>
<p>One of the nice things about this map is that it’s fully interactive. And that’s particularly helpful here because to really see the relation you’ll need to zoom in quite a bit. Because we added the optional <code>popup</code> argument to <code>addPolygons</code> and <code>addAwesomeMarkers</code>, we’re able to click to identify a specific census tract or the name of a specific school. If we wanted the plot to render differently we could change the provider. For example, you could produce a nice terrain map with <code>provider = &quot;Stamen.TerrainBackground&quot;</code>. All the different options are available <a href="http://leaflet-extras.github.io/leaflet-providers/preview/index.html">here</a>, where you can preview a map before applying it to yours.</p>
<p>Note that we have a very clear and very strong relation here - essentially all the red, pink, and white schools are in the more purple tracts, correpsonding to lower median housing price areas. This is powerful information but it is important that it’s not confused to mean that the lowest quality schools are located in the more impoverished areas. This information tells us very little about the quality of the school and, indeed, if we look at estimates of growth (shown below without all the code) there is a much less strong correlation. That is, the ratings schools receive on the amount of growth students make is less correlated with the median housing cost in the area than is absolute achievement, although there does still appear to be some correlation.</p>
<iframe seamless src="../2017-11-13-mapping-statewide-school-ratings-with-us-census-tracts_files/map_schools_growth.html" width="100%" height="500">
</iframe>
</div>
