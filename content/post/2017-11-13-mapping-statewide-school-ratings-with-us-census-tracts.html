---
title: Mapping Statewide School Ratings with US Census Tracts
author: Daniel Anderson
date: '2017-11-13'
slug: mapping-statewide-school-ratings-with-us-census-tracts
categories: []
tags:
  - data_vis
---



<p>In this post, I’d like to share some work related to geo-spatial mapping, statewide school ratings, and US Census Bureau data using census tracts. Specifically, I wanted to investigate whether there was a relation between the median housing price in an area, and the statewide achievement ratings for schools in the corresponding area. There is a <a href="https://cepa.stanford.edu/sites/default/files/may-sreardon.pdf">strong relation</a> between socio-economic status and student achievement, but less is known about how statewide ratings for schools relate to the demographics of the corresponding area. This is a rather long post, so you’ll have to have a bit of endurance to get through it all (I considered splitting it into two posts but it felt less cohesive).</p>
<p>This post uses the <a href="https://www.tidyverse.org">tidyverse</a> and <a href="https://rstudio.github.io/leaflet/">leaflet</a> packages, as well the terrific <a href="https://github.com/walkerke/tidycensus">tidycensus</a> package by Kyle Walker in conjunction with <a href="http://r-spatial.github.io/sf/">sf</a>. The <a href="https://github.com/dkahle/ggmap">ggmap</a> package is used for pulling lattitude and longitude data from physical addresses. Finally, this post builds off a <a href="https://juliasilge.com/blog/using-tidycensus/">wonderful post</a> by Julia Silge.</p>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>For this project, I wanted to use only publicly available data. I meandered around the Oregon Department of Education (ODE) website for a while and eventually came to the file I wanted: <a href="http://www.oregon.gov/ode/schools-and-districts/reportcards/reportcards/Pages/Accountability-Measures.aspx">Report Card Ratings for each school</a>. If you’ve explored my R course slides at all you know I’m a fan of Thomas Leeper’s <em>rio</em> package for data import. It just makes things easy. So let’s import the data directly from the ODE website and take a look.</p>
<pre class="r"><code># load packages for data import/prep
library(tidyverse)
library(rio)
library(janitor)

ratings &lt;- import(&quot;http://www.oregon.gov/ode/schools-and-districts/reportcards/reportcards/Documents/rcdetails_1617.xlsx&quot;,
                  setclass = &quot;tbl_df&quot;) %&gt;% 
            clean_names()

# Clean up the file to what we need
ratings &lt;- ratings %&gt;% 
  filter(district_name == &quot;Portland SD 1J&quot;) %&gt;% 
  spread(indicator, rating) %&gt;% 
  clean_names() %&gt;% 
  select(school_name, achievement) %&gt;% 
  mutate(achievement = parse_number(achievement)) %&gt;% 
  filter(!is.na(achievement))
    
ratings</code></pre>
<pre><code>## # A tibble: 84 x 2
##                      school_name achievement
##                            &lt;chr&gt;       &lt;dbl&gt;
##  1   Abernethy Elementary School           5
##  2   Ainsworth Elementary School           5
##  3     Alameda Elementary School           5
##  4      Arleta Elementary School           3
##  5       Astor Elementary School           3
##  6    Atkinson Elementary School           4
##  7  Rosa Parks Elementary School           2
##  8       Beach Elementary School           3
##  9        Beaumont Middle School           4
## 10 Boise-Eliot Elementary School           2
## # ... with 74 more rows</code></pre>
<p>In the above code, we import the ratings, filter for only schools in Portland School District, spread the data out so we have column for the achievement ratings, and then select only the two variables we really need - the school name and the achievement rating.This is a good start, but we don’t yet have the geographical coordinates of the schools. To do that, we’ll get another dataset from ODE that has the physical address of each school. We’ll then transform those addresses to lattitude and longitude using a bit of help from google. First, the addresses:</p>
<pre class="r"><code>addresses &lt;- import(&quot;http://www.ode.state.or.us/pubs/labels/SchoolMail.xls&quot;,
                    setclass = &quot;tbl_df&quot;) %&gt;% 
  clean_names() %&gt;% 
  filter(city == &quot;PORTLAND&quot;) %&gt;% 
  mutate(name = str_to_title(name)) %&gt;% 
  unite(address, c(address, city, state, zip), sep = &quot; &quot;) %&gt;% 
  select(name, address)
              
addresses</code></pre>
<pre><code>## # A tibble: 146 x 2
##                           name                                     address
##  *                       &lt;chr&gt;                                       &lt;chr&gt;
##  1 Abernethy Elementary School   2421 SE ORANGE AVE PORTLAND OR 97214-5398
##  2 Ainsworth Elementary School    2425 SW VISTA AVE PORTLAND OR 97201-2399
##  3   Alameda Elementary School   2732 NE FREMONT ST PORTLAND OR 97212-2542
##  4     Alder Elementary School    17200 SE ALDER ST PORTLAND OR 97233-4260
##  5     Alice Ott Middle School   12500 SE RAMONA ST PORTLAND OR 97236-4699
##  6        Alliance High School   4039 NE ALBERTA CT PORTLAND OR 97211-8199
##  7    Arleta Elementary School     5109 SE 66TH AVE PORTLAND OR 97206-4599
##  8              Arthur Academy 13717 SE DIVISION ST PORTLAND OR 97236-2841
##  9     Astor Elementary School       5601 N YALE ST PORTLAND OR 97203-5299
## 10  Atkinson Elementary School  5800 SE DIVISION ST PORTLAND OR 97206-1499
## # ... with 136 more rows</code></pre>
<p>We’ll now join the <em>addresses</em> dataset with our <em>ratings</em> dataset, which we know contains only the schools in Portland School District.</p>
<pre class="r"><code>d &lt;- inner_join(ratings, addresses, by = c(&quot;school_name&quot; = &quot;name&quot;))
d</code></pre>
<pre><code>## # A tibble: 81 x 3
##                      school_name achievement
##                            &lt;chr&gt;       &lt;dbl&gt;
##  1   Abernethy Elementary School           5
##  2   Ainsworth Elementary School           5
##  3     Alameda Elementary School           5
##  4      Arleta Elementary School           3
##  5       Astor Elementary School           3
##  6    Atkinson Elementary School           4
##  7  Rosa Parks Elementary School           2
##  8       Beach Elementary School           3
##  9        Beaumont Middle School           4
## 10 Boise-Eliot Elementary School           2
## # ... with 71 more rows, and 1 more variables: address &lt;chr&gt;</code></pre>
<p>Now, we can find the longitude and lattitude of each school using the physical address with the help of the <em>ggmap</em> package and, specifically, the <code>geocode</code> function.</p>
<pre class="r"><code>library(ggmap)
lat_long &lt;- geocode(d$address, source = &quot;dsk&quot;)
d &lt;- bind_cols(d, lat_long)
d</code></pre>
<pre><code>## # A tibble: 81 x 5
##                      school_name achievement
##                            &lt;chr&gt;       &lt;dbl&gt;
##  1   Abernethy Elementary School           5
##  2   Ainsworth Elementary School           5
##  3     Alameda Elementary School           5
##  4      Arleta Elementary School           3
##  5       Astor Elementary School           3
##  6    Atkinson Elementary School           4
##  7  Rosa Parks Elementary School           2
##  8       Beach Elementary School           3
##  9        Beaumont Middle School           4
## 10 Boise-Eliot Elementary School           2
## # ... with 71 more rows, and 3 more variables: address &lt;chr&gt;, lon &lt;dbl&gt;,
## #   lat &lt;dbl&gt;</code></pre>
</div>
<div id="mapping-the-data" class="section level2">
<h2>Mapping the data</h2>
<p>To map the data, we’ll use the <em>leaflet</em> package. We’ll first write a quick function that tells leaflet what color we want the schools in our map to appear depending on their statewide achievement rating.</p>
<pre class="r"><code>library(leaflet)

get_col &lt;- function(df, indicator) {
  sapply(df[[as.character(indicator)]], function(rating) {
    if(rating == 5) {
      &quot;green&quot;
    } else if(rating == 4) {
      &quot;lightgreen&quot;
    } else if(rating == 3) {
      &quot;white&quot;
    } else if(rating == 2) {
      &quot;lightred&quot;
    } else {
      &quot;red&quot;
    } })
}</code></pre>
<p>Next we’ll map the Portland area using the <em>tidycensus</em> and <em>sf</em> packages. Note that you have to have a US Census API key for these function to work. The <code>get_acs</code> function gets census tracts for Multnomah County. The variable argument tells the function to get information about the median housing cost of the area. See other variables with the <code>load_variables</code> function from the package. The <code>colorNumeric</code> function creates a pallete according to the estimate for the tract with the viridis palette (which not only looks nice but has good properties for color blindness and printing in black and white).</p>
<pre class="r"><code>library(tidycensus)
library(sf)

pdx_acs &lt;- get_acs(geography = &quot;tract&quot;, 
                     variables = &quot;B25077_001&quot;, 
                     state = &quot;OR&quot;,
                     county = &quot;Multnomah County&quot;,
                     geometry = TRUE)

pal &lt;- colorNumeric(palette = &quot;viridis&quot;, 
                    domain = pdx_acs$estimate)</code></pre>
<p>Finally, we produce the map. I’ll come back to this tomorrow morning to explain the rest of the code but it’s currently near 11:00 PM and I’m tired so I’m going to sleep.</p>
<pre class="r"><code>icons &lt;- awesomeIcons(
  icon = &#39;ios-close&#39;,
  iconColor = &#39;black&#39;,
  library = &#39;ion&#39;,
  markerColor = get_col(d, &quot;achievement&quot;)
)

cols &lt;- gplots::col2hex(c(&quot;red&quot;, &quot;pink&quot;, &quot;white&quot;, &quot;lightgreen&quot;, &quot;darkgreen&quot;))

pdx_acs %&gt;%
  st_transform(crs = &quot;+init=epsg:4326&quot;) %&gt;%
  leaflet() %&gt;%
  addProviderTiles(provider = &quot;CartoDB.Positron&quot;) %&gt;%
  addPolygons(popup = ~ str_extract(NAME, &quot;^([^,]*)&quot;),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal(estimate)) %&gt;%
  addLegend(&quot;bottomright&quot;, 
            pal = pal, 
            values = ~ estimate,
            title = &quot;Median Home Value&quot;,
            labFormat = labelFormat(prefix = &quot;$&quot;),
            opacity = 1) %&gt;% 
  addAwesomeMarkers(data = d, 
                    ~lon, 
                    ~lat, 
                    icon = icons, 
                    popup= ~school_name) %&gt;% 
  addLegend(&quot;bottomright&quot;, 
            colors = rev(cols),
            labels = 5:1,
            title = &quot;Achievement Ratings&quot;,
            opacity = 1)</code></pre>
<iframe seamless src="../map_schools/index.html" width="100%" height="500">
</iframe>
</div>
