---
title: Alluvial Diagrams with ggforce
author: Daniel Anderson
date: '2017-11-29'
slug: alluvial-plots-with-ggforce
categories: []
tags:
  - data_vis
---



<p>Today I wanted to quickly share my first real attempt at making an alluvial diagram. For those not familiar (and I wasn’t previously) an <a href="https://en.wikipedia.org/wiki/Alluvial_diagram">alluvial</a> diagram is a type of flow plot that is essentially equivalent to a <a href="https://developers.google.com/chart/interactive/docs/gallery/sankey">sankey</a> diagram. The difference is that while sankey diagrams show flow for different categorical variables, alluvial plots show change over time. To produce the alluvial diagram below, I’ll be using the development version of the excellent <a href="https://github.com/thomasp85/ggforce">ggforce</a> package written by <a href="https://twitter.com/thomasp85">Thomas Lin Pedersen</a>, who’s not only incredibly talented, but also a good follow on twitter.</p>
<p>** insert plot **</p>
<div id="context" class="section level2">
<h2>Context</h2>
<p>In schools across the country students who are struggling academically may be screened and evaluated to determine if they have a specific learning disability (SLD). Unfortunately, the protocols for making these determinations are not always consistent. We were interested, therefore, in examining the extent to which students shift into and out of the SLD classification over time. In this particular example, we only have data for middle school students (Grades 6-8), although <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.839.1628&amp;rep=rep1&amp;type=pdf">similar research</a> has examined other grades.</p>
</div>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>The actual dataset is rather large, and contains statewide testing records for all students in the state of Oregon across Grades 6-8 for three cohorts. For the purposes of this blogpost, I first simulated new data (so I could share it here) using the <a href="https://cran.r-project.org/web/packages/synthpop/vignettes/synthpop.pdf">synthpop</a> package, which is pretty impressive and perfect for this sort of purpose (I unfortunately am not allowed to share the real data publicly). I then took a random sample of 5% of the students in the synthetic data so it wouldn’t be so large. The data are available <a href="../data/synthetic_data2.csv">here</a>, and you can read the file in directly using the following block of code, (which also cleans up the names a bit and selects only the relevant variables).</p>
<pre class="r"><code>library(tidyverse)
d &lt;- read_csv(&quot;/Users/Daniel/Teaching/guest_lecture_Gina/synthetic_data2.csv&quot;) %&gt;% 
  janitor::clean_names() %&gt;% 
  select(sid, grade, sld, ld33)
d</code></pre>
<pre><code>## # A tibble: 11,298 x 4
##         sid grade   sld   ld33
##       &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;chr&gt;
##  1 12931993     6     0  Never
##  2  5757142     6     0  Never
##  3  7720394     6     0  Never
##  4  7035071     6     0  Never
##  5  7782160     6     0  Never
##  6  8306796     6     0  Never
##  7  8213712     6     1 Always
##  8  3808246     6     0  Never
##  9  2539721     6     0  Never
## 10  6730043     6     0  Never
## # ... with 11,288 more rows</code></pre>
<p>The <em>sld</em> column is a dummy vector indicating if the given student (<em>sid</em>) was identified with a specific learning disability in that grade (1) or not (0). The <em>ld33</em> column has an odd name, but basically states if the student was always, never, or sometimes identified as SLD.</p>
</div>
<div id="the-alluvial-plot" class="section level2">
<h2>The alluvial plot</h2>
<p>We first need to install the development version of <em>ggforce</em>.</p>
<pre class="r"><code>devtools::install_github(&quot;thomasp85/ggforce&quot;)</code></pre>
<p>Next, we need to do a bit of data prep. Below I: * <code>filter()</code> for only students who were <em>ever</em> identified as SLD - i.e., I’m eliminating students who were always identified as Non-SLD, because that group encompasses the majority of students and makes the rest of the patterns difficult to see.</p>
<ul>
<li><p>Recode <code>ld</code> and <code>grade</code> so they are character vectors. This is not only helpful in making the plot look nice, but actually vital in getting it to produce (I failed over and over again because I skipped this step in my initial attempts).</p></li>
<li><p><code>spread</code> the data out so there’s a column specifying the <em>ld</em> status for each student in each grade.</p></li>
<li><p><code>count</code> the number of unique patterns across grades. This will be used to provide the widths of the alluvial plot.</p></li>
<li><p><code>mutate</code> to create a new pattern variable that states, in a single variable, which “flow” students in that group were in.</p></li>
</ul>
<p>Note - I saved this all in an object <code>pd</code>, which is a general convention I use that stands for plot data.</p>
<pre class="r"><code>pd &lt;- d %&gt;% 
  filter(ld33 != &quot;Never&quot;) %&gt;%
  mutate(sld = ifelse(sld == 0, &quot;Non-SLD&quot;, &quot;SLD&quot;),
         grade = paste0(&quot;Grade &quot;, grade)) %&gt;% 
  spread(grade, sld) %&gt;% 
  group_by(`Grade 6`, `Grade 7`, `Grade 8`) %&gt;% 
  count() %&gt;% 
  mutate(Pattern = paste(`Grade 6`, `Grade 7`, `Grade 8`, sep = &quot;/&quot;))
pd</code></pre>
<pre><code>## # A tibble: 7 x 5
## # Groups:   Grade 6, Grade 7, Grade 8 [7]
##   `Grade 6` `Grade 7` `Grade 8`     n             Pattern
##       &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt; &lt;int&gt;               &lt;chr&gt;
## 1   Non-SLD   Non-SLD       SLD    16 Non-SLD/Non-SLD/SLD
## 2   Non-SLD       SLD   Non-SLD     1 Non-SLD/SLD/Non-SLD
## 3   Non-SLD       SLD       SLD    19     Non-SLD/SLD/SLD
## 4       SLD   Non-SLD   Non-SLD    17 SLD/Non-SLD/Non-SLD
## 5       SLD   Non-SLD       SLD     1     SLD/Non-SLD/SLD
## 6       SLD       SLD   Non-SLD    20     SLD/SLD/Non-SLD
## 7       SLD       SLD       SLD   217         SLD/SLD/SLD</code></pre>
<p>Now we’re getting close, but the actual format <code>ggforce</code> needs the data in is a bit more complex. Luckily, the package provides a helper function. We just need to tell it, basically, which columns we want along the x-axis.</p>
<pre class="r"><code>library(ggforce)
pd &lt;- pd %&gt;% 
  gather_set_data(1:3)

pd</code></pre>
<pre><code>## # A tibble: 21 x 8
## # Groups:   Grade 6, Grade 7, Grade 8 [7]
##    `Grade 6` `Grade 7` `Grade 8`     n             Pattern    id       x
##        &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt; &lt;int&gt;               &lt;chr&gt; &lt;int&gt;   &lt;chr&gt;
##  1   Non-SLD   Non-SLD       SLD    16 Non-SLD/Non-SLD/SLD     1 Grade 6
##  2   Non-SLD       SLD   Non-SLD     1 Non-SLD/SLD/Non-SLD     2 Grade 6
##  3   Non-SLD       SLD       SLD    19     Non-SLD/SLD/SLD     3 Grade 6
##  4       SLD   Non-SLD   Non-SLD    17 SLD/Non-SLD/Non-SLD     4 Grade 6
##  5       SLD   Non-SLD       SLD     1     SLD/Non-SLD/SLD     5 Grade 6
##  6       SLD       SLD   Non-SLD    20     SLD/SLD/Non-SLD     6 Grade 6
##  7       SLD       SLD       SLD   217         SLD/SLD/SLD     7 Grade 6
##  8   Non-SLD   Non-SLD       SLD    16 Non-SLD/Non-SLD/SLD     1 Grade 7
##  9   Non-SLD       SLD   Non-SLD     1 Non-SLD/SLD/Non-SLD     2 Grade 7
## 10   Non-SLD       SLD       SLD    19     Non-SLD/SLD/SLD     3 Grade 7
## # ... with 11 more rows, and 1 more variables: y &lt;chr&gt;</code></pre>
<p>And now we’re all ready to go. The set of functions <em>ggforce</em> provides to produce the alluvial plot is <code>geom_parallel_sets</code>. The basic plot can now be produced with</p>
<pre class="r"><code>ggplot(pd, aes(x = x, id = id, split = y, value = n)) +
    geom_parallel_sets(aes(fill = Pattern), alpha = 0.6) +
    geom_parallel_sets_axes(axis.width = 0.1, fill = &quot;gray70&quot;) +
    geom_parallel_sets_labels(color = &#39;White&#39;, size = 6)</code></pre>
<p><img src="/post/2017-11-29-alluvial-plots-with-ggforce_files/figure-html/alluvial_plot1-1.png" width="864" /></p>
<p>And we’re basically there!</p>
<p>A bit of cleaning up will make the plot even a bit nicer. Here I’ve used <code>theme_void</code> to remove most of the extras like axes, but added back in the labels on the x-axis. I’ve also repositioned the legend, and it’s debatable whether it’s really needed at all. Also, the <code>scale_x_discrete(expand = c(0.05,0.05))</code> argument is important and removes a bunch of white space on the left and right margins.</p>
<pre class="r"><code>ggplot(pd, aes(x = x, id = id, split = y, value = n)) +
  geom_parallel_sets(aes(fill = Pattern), alpha = 0.6) +
  geom_parallel_sets_axes(axis.width = 0.1, fill = &quot;gray70&quot;) +
  geom_parallel_sets_labels(color = &#39;White&#39;, size = 6) +
  scale_fill_brewer(palette = &quot;Dark2&quot;) +
  labs(x = &quot;&quot;, y = &quot;&quot;) +
  scale_x_discrete(expand = c(0.05,0.05)) +
  theme_void() + 
  theme(
    axis.text = element_text(size = 12),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 0),
    legend.position = &quot;bottom&quot;,
    legend.direction = &quot;horizontal&quot;
    )</code></pre>
<p><img src="/post/2017-11-29-alluvial-plots-with-ggforce_files/figure-html/alluvial_plot2-1.png" width="864" /></p>
</div>
