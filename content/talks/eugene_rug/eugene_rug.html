---
title: "Developing Your First R Package"
subtitle: "A Case Study with esvis"
author: "Daniel Anderson"
date: "2018/12/12"
output:
  xaringan::moon_reader:
    css: ["default", "uo", "uo-fonts", "hygge"]
    lib_dir: libs
    nature:
      highlightStyle: atelier-dune-light
      highlightLines: true
      countIncrementalSlides: false
---



<div id="want-to-follow-along" class="section level1">
<h1>Want to follow along?</h1>
<p>If you’d like to follow along, pleae make sure you have the following packages installed</p>
<pre class="r"><code>install.packages(c(&quot;tidyverse&quot;, &quot;esvis&quot;, 
                   &quot;devtools&quot;, &quot;roxygen2&quot;, 
                   &quot;usethis&quot;))</code></pre>
<p>class: inverse
background-image: url(img/fams.png)
#.right[the fam]</p>
</div>
<div id="when-should-you-write-a-function" class="section level1">
<h1>When should you write a function?</h1>
<div id="hadleys-rule" class="section level3">
<h3>Hadley’s rule</h3>
<blockquote>
<p>You should consider writing a function whenever you’ve copied and pasted a block of code more than twice (i.e. you now have three copies of the same code).</p>
</blockquote>
<p>.right[<a href="http://r4ds.had.co.nz/functions.html">r4ds</a>]</p>
<p><img src="img/r4ds.png" height="200px" align = "right"/></p>
</div>
</div>
<div id="bundle-your-functions" class="section level1">
<h1>Bundle your functions</h1>
<p>Once you’ve written more than one function, you may want to bundle them. There are two general ways to do this:</p>
<p>–</p>
<p>.pull-left[
.center[.Large[source?]]]</p>
<p>.pull-right[
.center[.Large[Write a package]]]</p>
<p>–</p>
<center>
<img src = "img/twopaths.png" width = 400 align = "middle" />
</center>
</div>
<div id="more-importantly" class="section level1">
<h1>More importantly</h1>
<p>.Large[Bundling functions into a package is not that hard!]</p>
<p><img src="https://media.giphy.com/media/3ohzdTQaODeGPt90uk/source.gif" /></p>
</div>
<div id="background" class="section level1">
<h1>Background</h1>
<div id="effect-sizes" class="section level3">
<h3>Effect sizes</h3>
<p>Standardized mean differences</p>
<p>–</p>
<ul>
<li>Assumes reasonably normally distributed distributions (mean is a good indicator of central tendency)</li>
</ul>
<p>–</p>
<ul>
<li>Differences in means may not reflect differences at all points in scale if variances are different</li>
</ul>
<p>–</p>
<ul>
<li>Substantive interest may also lie with differences at other points in the distribution.</li>
</ul>
</div>
</div>
<div id="restructure-the-data-for-plotting" class="section level1">
<h1>Restructure the data for plotting</h1>
<pre class="r"><code>d &lt;- d %&gt;% 
  gather(group, value, -var) 
d</code></pre>
<pre><code>## # A tibble: 4,000 x 3
##    var    group value
##    &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt;
##  1 common low   10.8 
##  2 common low   10.7 
##  3 common low    9.47
##  4 common low   10.1 
##  5 common low   10.7 
##  6 common low    9.25
##  7 common low   10.8 
##  8 common low   10.8 
##  9 common low    9.82
## 10 common low    9.74
## # ... with 3,990 more rows</code></pre>
</div>
<div id="binned-effect-sizes" class="section level1">
<h1>Binned effect sizes</h1>
<ol style="list-style-type: decimal">
<li>Cut the distributions into <span class="math inline">\(n\)</span> bins (based on percentiles)</li>
<li>Calculate the mean difference between paired bins</li>
<li>Divide each mean difference by the overall pooled standard deviation</li>
</ol>
<p><span class="math display">\[
d\_{[i]} = \frac{\bar{X}\_{foc\_{[i]}} - \bar{X}\_{ref\_{[i]}}}
        {\sqrt{\frac{(n\_{foc} - 1)Var\_{foc} + (n\_{ref} - 1)Var\_{ref}}
                  {n\_{foc} + n\_{ref} - 2}}}
\]</span></p>
<table style="width:4%;">
<colgroup>
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th>### visualize it!</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td># Back to the simultated example</td>
</tr>
<tr class="even">
<td><code>r common &lt;- filter(d, var == &quot;common&quot;) diff   &lt;- filter(d, var == &quot;diff&quot;)</code></td>
</tr>
<tr class="odd">
<td><code>r library(esvis) qtile_es(value ~ group, common)</code></td>
</tr>
<tr class="even">
<td><code>##   ref_group foc_group low_qtile high_qtile midpoint        es         se ## 1      high       low      0.00       0.33    0.165 -2.140207 0.09777340 ## 2      high       low      0.33       0.66    0.495 -2.131032 0.09747298 ## 3      high       low      0.66       0.99    0.825 -2.052756 0.09619191</code></td>
</tr>
<tr class="odd">
<td><code>r qtile_es(value ~ group, diff)</code></td>
</tr>
<tr class="even">
<td><code>##   ref_group foc_group low_qtile high_qtile midpoint         es         se ## 1      high       low      0.00       0.33    0.165 -0.4696392 0.07903561 ## 2      high       low      0.33       0.66    0.495 -1.1956026 0.08451943 ## 3      high       low      0.66       0.99    0.825 -1.8267267 0.09267461</code></td>
</tr>
</tbody>
</table>
</div>
<div id="visualize-it" class="section level1">
<h1>Visualize it</h1>
<p>.pull-left[
### Common Variance</p>
<pre class="r"><code>binned_plot(value ~ group, common)</code></pre>
<p><img src="/talks/eugene_rug/eugene_rug_files/figure-html/sim_binned_plot_common-1.png" width="672" />
]</p>
<p>.pull-right[
### Different Variance</p>
<pre class="r"><code>binned_plot(value ~ group, diff)</code></pre>
<p><img src="/talks/eugene_rug/eugene_rug_files/figure-html/sim_binned_plot_diff-1.png" width="672" />
]</p>
<p>class: inverse middle center
# taking a step back</p>
</div>
<div id="some-resources" class="section level1">
<h1>Some resources</h1>
<p>We surely won’t get through all the steps tonight. In my mind, the best resources are:</p>
<p>.pull-left[
### Advanced R
<img src = "https://images-na.ssl-images-amazon.com/images/I/41Qkod8KOBL._SX329_BO1,204,203,200_.jpg" height = 280 />]</p>
<p>.pull-right[
### R Packages
<img src = "http://r-pkgs.had.co.nz/cover.png" height = 280 />]</p>
<p>–</p>
<p>.footnote[For a really quick but really good intro, see <a href="https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/">Hilary Parker’s</a> blog post]</p>
</div>
<div id="our-function" class="section level1">
<h1>Our function</h1>
<ul>
<li>Let’s have it return either (a) a named vector, or (b) a dataframe .grey[.small[(whichever you prefer is fine)]]</li>
<li>What will be the formal arguments?</li>
<li>What will the body look like?</li>
</ul>
<table style="width:4%;">
<colgroup>
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th>### Want to give it a go?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td># The approach I took…</td>
</tr>
<tr class="even">
<td>```r
describe &lt;- function(x) {
n &lt;- as.integer(length(na.omit(x)))
nmiss &lt;- as.integer(sum(is.na(x)))
mn &lt;- mean(x, na.rm = TRUE)
stdev &lt;- sd(x, na.rm = TRUE)</td>
</tr>
<tr class="odd">
<td>out &lt;- tibble::tibble(n_valid = n,
n_missing = nmiss,
mean = mn,
sd = stdev)
out
}
```</td>
</tr>
</tbody>
</table>
</div>
<div id="the-approach-i-took" class="section level1">
<h1>The approach I took…</h1>
<pre class="r"><code>describe &lt;- function(x) {
  {{n     &lt;- as.integer(length(na.omit(x)))}} # Count number of valid cases
  nmiss &lt;- as.integer(sum(is.na(x)))
  mn    &lt;- mean(x, na.rm = TRUE)
  stdev &lt;- sd(x, na.rm = TRUE)
  
  out &lt;- tibble::tibble(n_valid   = n, 
                        n_missing = nmiss, 
                        mean      = mn, 
                        sd        = stdev)
  out
}</code></pre>
</div>
<div id="the-approach-i-took-1" class="section level1">
<h1>The approach I took…</h1>
<pre class="r"><code>describe &lt;- function(x) {
  n     &lt;- as.integer(length(na.omit(x)))
  nmiss &lt;- as.integer(sum(is.na(x)))
  {{mn    &lt;- mean(x, na.rm = TRUE)}} # Calculate mean
  stdev &lt;- sd(x, na.rm = TRUE)
  
  out &lt;- tibble::tibble(n_valid   = n, 
                        n_missing = nmiss, 
                        mean      = mn, 
                        sd        = stdev)
  out
}</code></pre>
</div>
<div id="the-approach-i-took-2" class="section level1">
<h1>The approach I took…</h1>
<pre class="r"><code>describe &lt;- function(x) {
  n     &lt;- as.integer(length(na.omit(x)))
  nmiss &lt;- as.integer(sum(is.na(x)))
  mn    &lt;- mean(x, na.rm = TRUE)
  stdev &lt;- sd(x, na.rm = TRUE)
  
  {{out &lt;- tibble::tibble(n_valid   = n,     # Bundle it all
                        n_missing = nmiss, 
                        mean      = mn, 
                        sd        = stdev)}}
  out
}</code></pre>
</div>
<div id="informal-testing" class="section level1">
<h1>Informal testing</h1>
<pre class="r"><code>describe(rnorm(100))</code></pre>
<pre><code>## # A tibble: 1 x 4
##   n_valid n_missing    mean    sd
##     &lt;int&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1     100         0 -0.0214  1.14</code></pre>
<pre class="r"><code>describe(c(rnorm(1000, 10, 4), rep(NA, 27)))</code></pre>
<pre><code>## # A tibble: 1 x 4
##   n_valid n_missing  mean    sd
##     &lt;int&gt;     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1    1000        27  10.0  3.92</code></pre>
</div>
<div id="roxygen2-comments" class="section level1">
<h1>roxygen2 comments</h1>
<p><strong>Typical arguments</strong>
* <code>@param</code>: Describe the formal arguments. State argument name and the describe it.</p>
<blockquote>
<p><code>#' @param x Vector to describe</code></p>
</blockquote>
<ul>
<li><code>@return</code>: What does the function return</li>
</ul>
<blockquote>
<p><code>#' @return A tibble with descriptive data</code></p>
</blockquote>
<ul>
<li><code>@example</code> or more commonly <code>@examples</code>: Provide examples of the use of your function.</li>
<li><code>@export</code>: Export your function</li>
</ul>
<p>If you don’t include <code>@export</code>, your function will be <em>internal</em>, meaning others can’t access it easily.</p>
</div>
<div id="description" class="section level1">
<h1><code>DESCRIPTION</code></h1>
<p>Metadata about the package. Default fields for our package are</p>
<pre><code>Package: practice
Version: 0.0.0.9000
Title: What the Package Does (One Line, Title Case)
Description: What the package does (one paragraph).
Authors@R: person(&quot;First&quot;, &quot;Last&quot;, email = &quot;first.last@example.com&quot;, role = c(&quot;aut&quot;, &quot;cre&quot;))
License: What license is it under?
Encoding: UTF-8
LazyData: true
ByteCompile: true
RoxygenNote: 6.0.1</code></pre>
<p>–</p>
<p>This is where the information for <code>citation(package = &quot;practice&quot;)</code> will come from.</p>
<p>–</p>
<p>Some advice - edit within RStudio, or a good text editor like <a href="http://www.sublimetext.com">sublimetext</a>. “Fancy” quotes and things can screw this up.</p>
</div>
<div id="description-for-esvis" class="section level1">
<h1><code>DESCRIPTION</code> for {esvis}</h1>
<pre><code>Package: esvis
Type: Package
Title: Visualization and Estimation of Effect Sizes
Version: 0.1.0.9000
Authors@R: person(&quot;Daniel&quot;, &quot;Anderson&quot;, email = &quot;daniela@uoregon.edu&quot;, 
       role = c(&quot;aut&quot;, &quot;cre&quot;))
Description: A variety of methods are provided to estimate and visualize
    distributional differences in terms of effect sizes. Particular emphasis
    is upon evaluating differences between two or more distributions across
    the entire scale, rather than at a single point (e.g., differences in
    means). For example, Probability-Probability (PP) plots display the
    difference between two or more distributions, matched by their empirical
    CDFs (see Ho and Reardon, 2012; &lt;doi:10.3102/1076998611411918&gt;), allowing
    for examinations of where on the scale distributional differences are
    largest or smallest. The area under the PP curve (AUC) is an effect-size
    metric, corresponding to the probability that a randomly selected
    observation from the x-axis distribution will have a higher value
    than a randomly selected observation from the y-axis distribution. 
    Binned effect size plots are also available, in which the distributions
    are split into bins (set by the user) and separate effect sizes (Cohen&#39;s
    d) are produced for each bin - again providing a means to evaluate the
    consistency (or lack thereof) of the difference between two or more 
    distributions at different points on the scale. Evaluation of empirical 
    CDFs is also provided, with  built-in arguments for providing annotations 
    to help evaluate distributional differences at specific points (e.g., 
    semi-transparent shading). All function take a consistent argument 
    structure. Calculation of specific effect sizes is also possible. The
    following effect sizes are estimable: (a) Cohen&#39;s d, (b) Hedges&#39; g, 
    (c) percentage above a cut, (d) transformed (normalized) percentage above 
    a cut, (e)  area under the PP curve, and (f) the V statistic (see Ho, 
    2009; &lt;doi:10.3102/1076998609332755&gt;), which essentially transforms the 
    area under the curve to standard deviation units. By default, effect sizes 
    are calculated for all possible pairwise comparisons, but a reference 
    group (distribution) can be specified.</code></pre>
<p>class: inverse
# Demo
* Change the author name.
+ Add a contributer just for fun.
* Add a license. We’ll go for MIT license using <code>usethis::use_mit_license(&quot;First and Last Name&quot;)</code>
* Install and reload.</p>
<p>class: inverse center middle</p>
</div>
<div id="demo" class="section level1">
<h1>Demo</h1>
</div>
<div id="testing" class="section level1">
<h1>Testing</h1>
<p>We’ll skip over testing for today, because we just don’t have time to cover everything. A few good resources:</p>
<p>.pull-left[
<img src = "https://images.tandf.co.uk/common/jackets/amazon/978149876/9781498763653.jpg" height = "375" />]</p>
<p>.pull-right[
<a href="https://www.amazon.com/Testing-Code-Chapman-Hall-CRC/dp/1498763650">Richie Cotton’s book</a></p>
<p><a href="http://r-pkgs.had.co.nz/tests.html">r-pkgs Chapter</a></p>
<p><a href="http://kbroman.org/pkg_primer/pages/tests.html">Karl Broman Blog Post</a>
]</p>
<p>class: inverse center middle
# Let’s check now!</p>
</div>
<div id="a-few-other-best-practices" class="section level1">
<h1>A few other best practices</h1>
<ul>
<li>Create a <code>README</code> with <code>usethis::use_readme_rmd</code>.</li>
</ul>
<p>–</p>
<ul>
<li>Try to get your <a href="https://en.wikipedia.org/wiki/Code_coverage">code coverage</a> up above 80%.</li>
</ul>
<p>–</p>
<ul>
<li>Automate wherever possible ({devtools} and {usethis} help a lot with this)</li>
</ul>
<p>–</p>
<ul>
<li>Use the <a href="https://github.com/MangoTheCat/goodpractice">{goodpractice}</a> package to help you package code be more robust, specifically with <code>goodpractice::gp()</code>. It will give you lots of good ideas</li>
</ul>
<p>–</p>
<ul>
<li>Host on GitHub, and capitalize on integration with other systems (all free, but require registering for an account)
<ul>
<li><a href="https://travis-ci.org">Travis CI</a></li>
<li><a href="https://www.appveyor.com">Appveyor</a></li>
<li><a href="https://codecov.io">codecov</a></li>
</ul></li>
</ul>
<p>class: center middle</p>
<p><i class="fa fa-github fa-5x"></i>
# <a href="https://github.com/DJAnderson07/esvis">esvis</a></p>
</div>
<div id="create-a-readme" class="section level1">
<h1>Create a <code>README</code></h1>
<ul>
<li>Use standard R Markdown. Setup the infrastructure with <code>usethis::use_readme_rmd</code>.</li>
<li>Write it just like a normal R Markdown doc and it should all flow into the <code>README</code>.</li>
</ul>
<p><img src = "img/esvis-README.png" height = 325 /></p>
</div>
<div id="codevoc" class="section level1">
<h1>codevoc</h1>
<p>You can test your code coverage each time you push a new commit by using <a href="https://codecov.io">codecov</a>. Initialize with <code>usethis::use_coverage()</code>. Overall setup process is pretty similar to Travis CI/Appveyor.</p>
<p>Easily see what is/is not covered by tests!</p>
<p><img src = "img/codecov.png" height = 325 /></p>
<hr />
<p>class: inverse center middle</p>
</div>
<div id="thats-all" class="section level1">
<h1>That’s all</h1>
<div id="thanks-so-much" class="section level3">
<h3>Thanks so much!</h3>
</div>
</div>
